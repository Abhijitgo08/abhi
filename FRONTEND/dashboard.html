<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard | JalRakshak 1.0 ‚Äî Demo</title>

  <!-- Tailwind for quick layout -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">

  <!-- Leaflet & Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

  <style>
  /* ----- Base layout & fonts ----- */
  :root{
    --glass-bg: rgba(255,255,255,0.40);
    --panel-bg: rgba(255,255,255,0.92);
    --muted: #6b7280;
    --accent-green: #16a34a;
    --card-radius: 12px;
    --shadow-1: 0 6px 18px rgba(0,0,0,0.08);
    --shadow-2: 0 8px 30px rgba(0,0,0,0.12);
  }
  html,body{ height:100%; margin:0; padding:0; }
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(180deg, rgba(7,89,80,0.18), rgba(0,0,0,0.15)), url('back.jpeg') no-repeat center center fixed;
    background-size: cover;
    color: #111827;
    min-height:100vh;
    display:flex; flex-direction:column;
  }
  h1,h2,h3{ font-family:'Poppins',sans-serif; }

  nav { z-index: 10050; }

  /* card & modal */
  .card { background: var(--glass-bg); backdrop-filter: blur(6px); border-radius: var(--card-radius); box-shadow: var(--shadow-1); }
  .modal { width: min(780px,94%); background:white; border-radius:10px; padding:18px; box-shadow: var(--shadow-2); }

  /* map */
  #map { height:400px; width:100%; border-radius:12px; overflow:hidden; box-shadow:var(--shadow-2); position:relative; z-index:0; }
  .leaflet-container { z-index: 0 !important; background: transparent; }
  .leaflet-pane, .leaflet-overlay-pane, .leaflet-marker-pane { z-index: 0 !important; }

  /* dropdown */
  .surface-dropdown { position: relative; display:inline-block; width:100%; z-index:10010; }
  .surface-dropdown-btn {
    width:100%; text-align:left; background:white; border:1px solid #e5e7eb; padding:0.5rem .75rem; border-radius:0.5rem;
    display:flex; align-items:center; justify-content:space-between; cursor:pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .surface-dropdown-btn:focus { outline:3px solid rgba(99,102,241,0.12); }

  .surface-dropdown-menu {
    position:absolute; z-index:10020; left:0; right:0; background:white; border:1px solid rgba(0,0,0,0.08);
    box-shadow:0 10px 30px rgba(0,0,0,0.12); border-radius:8px; margin-top:6px; padding:8px;
    max-height:260px; overflow:auto; pointer-events:auto; display:none;
  }

  .surface-item { display:flex; align-items:center; gap:10px; padding:10px 8px; border-radius:6px; cursor:pointer; user-select:none; }
  .surface-item:hover, .surface-item:focus { background: rgba(0,0,0,0.03); }
  .surface-item input[type="checkbox"] { width:16px; height:16px; margin:0; accent-color:var(--accent-green); }
  .surface-item .label { font-size:13px; color:#111827; }
  .surface-note { font-size:12px; color:var(--muted); margin-top:6px; padding:0 6px; }

  @media (max-width:520px) { .surface-dropdown-menu { position: static; margin-top:8px; } }

  /* small utilities */
  .hidden { display:none !important; }
  .muted { color:var(--muted); font-size:13px; }
  footer { position:relative; z-index:10020; }
  </style>
</head>

<body class="text-gray-800 min-h-screen flex flex-col">
  <nav class="flex items-center justify-between px-8 py-4 shadow-md bg-white/30 backdrop-blur-md">
    <div class="flex items-center space-x-3">
      <div style="width:48px;height:48px;background:#10b981;border-radius:8px;"></div>
      <span class="text-2xl font-bold text-white">JalRakshak 1.0</span>
    </div>
    <div class="flex items-center space-x-3">
      <button class="px-4 py-2 rounded-lg bg-green-600/80 text-white font-semibold">‚Üê Back</button>
      <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="User" class="w-12 h-12 rounded-full border-2 border-white">
    </div>
  </nav>

  <main class="flex-1 px-8 py-10">
    <h1 class="text-3xl font-bold text-white mb-4">Welcome, <span id="userName">User</span> üëã</h1>

    <!-- Inputs -->
    <section class="mb-8">
      <h2 class="text-2xl font-semibold text-white mb-4">1. Inputs</h2>

      <div class="grid md:grid-cols-2 gap-6">
        <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow">
          <label class="block text-sm font-medium text-gray-700">Location</label>
          <select id="locationSelect" class="w-full mt-2 px-4 py-2 border rounded-lg bg-white/70">
            <option value="">Test location</option>
          </select>
        </div>

        <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow">
          <label class="block text-sm font-medium text-gray-700">Number of Dwellers</label>
          <input type="number" id="dwellersInput" placeholder="e.g. 5" min="0" class="w-full mt-2 px-4 py-2 border rounded-lg bg-white/70">
        </div>

        <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow">
          <label class="block text-sm font-medium text-gray-700">Roof Type</label>
          <select id="roofTypeInput" class="w-full mt-2 px-4 py-2 border rounded-lg bg-white/70">
            <option value="Concrete">Concrete</option>
            <option value="Metal">Metal</option>
          </select>
        </div>

        <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow">
          <label class="block text-sm font-medium text-gray-700">Floors</label>
          <input type="number" id="floors" placeholder="e.g. 1" min="0" value="1" class="w-full mt-2 px-4 py-2 border rounded-lg bg-white/70">
          <p class="mt-2 text-xs text-gray-600">Vertical pipe length = floors √ó floor height.</p>
        </div>

        <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow">
          <label class="block text-sm font-medium text-gray-700">Soil Type</label>
          <select id="soilType" class="w-full mt-2 px-4 py-2 border rounded-lg bg-white/70">
            <option value="loamy" selected>Loamy</option>
            <option value="sandy">Sandy</option>
            <option value="clayey">Clayey</option>
          </select>
        </div>

        <!-- Open-space -->
        <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow col-span-2">
          <label class="inline-flex items-center space-x-3">
            <input id="includeOpenSpace" type="checkbox" class="rounded border-gray-300" />
            <span class="text-sm font-medium text-gray-700">Include open-space / courtyard</span>
          </label>
          <p class="mt-2 text-xs text-gray-600">If enabled: draw a ground polygon and pick surface types from the dropdown below.</p>

          <label class="block mt-4 text-sm font-medium text-gray-700">Open-space Surface Types</label>

          <!-- Compact dropdown with checkbox list -->
          <div class="mt-2">
            <div class="surface-dropdown" id="surfaceDropdownRoot">
              <button type="button" id="surfaceDropdownBtn" class="surface-dropdown-btn" aria-haspopup="true" aria-expanded="false">
                <span id="surfaceDropdownLabel" style="font-size:14px; color:#374151;">Select surface types‚Ä¶</span>
                <svg id="surfaceDropdownCaret" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06-.02L10 10.584l3.71-3.396a.75.75 0 111.02 1.098l-4 3.666a.75.75 0 01-1.02 0l-4-3.666a.75.75 0 01-.02-1.06z" clip-rule="evenodd" /></svg>
              </button>

              <div id="surfaceDropdownMenu" class="surface-dropdown-menu" role="menu" aria-hidden="true">
                <div class="surface-item" data-key="water_tight" tabindex="0">
                  <input type="checkbox" id="surf_water_tight" value="water_tight" />
                  <label for="surf_water_tight" class="label">Water-tight / Paved <span class="text-xs text-gray-500">‚âà0.70‚Äì0.95</span></label>
                </div>
                <div class="surface-item" data-key="asphalt" tabindex="0">
                  <input type="checkbox" id="surf_asphalt" value="asphalt" />
                  <label for="surf_asphalt" class="label">Asphalt pavement <span class="text-xs text-gray-500">‚âà0.85‚Äì0.90</span></label>
                </div>
                <div class="surface-item" data-key="open_joints" tabindex="0">
                  <input type="checkbox" id="surf_open_joints" value="open_joints" />
                  <label for="surf_open_joints" class="label">Stone/brick (open joints) <span class="text-xs text-gray-500">‚âà0.50‚Äì0.70</span></label>
                </div>
                <div class="surface-item" data-key="unpaved" tabindex="0">
                  <input type="checkbox" id="surf_unpaved" value="unpaved" />
                  <label for="surf_unpaved" class="label">Unpaved / vacant lot <span class="text-xs text-gray-500">‚âà0.10‚Äì0.30</span></label>
                </div>
                <div class="surface-item" data-key="parks" tabindex="0">
                  <input type="checkbox" id="surf_parks" value="parks" />
                  <label for="surf_parks" class="label">Parks / lawns / meadows <span class="text-xs text-gray-500">‚âà0.05‚Äì0.25</span></label>
                </div>

                <div class="surface-note">Click each item to toggle. Multiple items allowed. Selections are used to compute an average runoff coefficient.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Map -->
    <section class="mb-10">
      <h2 class="text-2xl font-semibold text-white mb-4">2. Mark Your Roof (and Open Space)</h2>
      <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow">
        <div id="map"></div>
        <p class="mt-3 text-sm text-gray-700">Draw roof first, then ground (if enabled).</p>
        <p class="mt-2 font-semibold text-blue-600">Roof Area: <span id="roofArea">0</span> m¬≤</p>
        <p class="mt-1 font-semibold text-orange-600 hidden" id="groundAreaWrap">Ground Area: <span id="groundArea">0</span> m¬≤</p>
      </div>
    </section>

    <!-- Analysis -->
    <section class="mb-12">
      <h2 class="text-2xl font-semibold text-white mb-4">3. Analysis</h2>
      <div class="p-6 bg-white/40 backdrop-blur-lg rounded-2xl shadow flex flex-col items-center">
        <button id="analyzeBtn" class="bg-green-600/90 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">Run Feasibility Analysis</button>
        <div id="analysisResult" class="mt-6 text-center text-gray-800 hidden"></div>
      </div>
    </section>
  </main>

  <footer class="bg-gray-900/70 backdrop-blur-md text-gray-200 text-center py-6">
    <p>&copy; JalRakshak ‚Äî demo.</p>
  </footer>

  <!-- Turf (area calc) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Dropdown logic: robust, moves menu to body to avoid clipping -->
  <script>
  (function () {
    const root = document.getElementById('surfaceDropdownRoot');
    const btn = document.getElementById('surfaceDropdownBtn');
    const menu = document.getElementById('surfaceDropdownMenu');
    const labelEl = document.getElementById('surfaceDropdownLabel');

    const APPEND_TO_BODY = true;
    if (APPEND_TO_BODY && menu.parentElement !== document.body) {
      root._menuWasMoved = true;
      document.body.appendChild(menu);
      menu.style.position = 'absolute';
    }

    function getSelectedGroundSurfaces() {
      const v = [];
      menu.querySelectorAll('input[type="checkbox"]').forEach(i => { if (i.checked) v.push(i.value); });
      return v;
    }
    window.getSelectedGroundSurfaces = getSelectedGroundSurfaces;

    function updateLabel() {
      const vals = getSelectedGroundSurfaces();
      if (!vals || vals.length === 0) labelEl.textContent = 'Select surface types‚Ä¶';
      else if (vals.length === 1) {
        const el = menu.querySelector('input[type="checkbox"][value="' + vals[0] + '"]');
        labelEl.textContent = el ? el.parentElement.querySelector('.label').innerText.trim() : vals[0];
      } else {
        labelEl.textContent = vals.length + ' selected';
      }
    }

    function openMenu() {
      if (menu.parentElement === document.body) {
        const rect = btn.getBoundingClientRect();
        const left = Math.max(8, rect.left);
        menu.style.left = left + 'px';
        menu.style.top = (rect.bottom + 6) + 'px';
        menu.style.width = rect.width + 'px';
      }
      menu.style.display = 'block';
      btn.setAttribute('aria-expanded', 'true');
    }
    function closeMenu() {
      menu.style.display = 'none';
      btn.setAttribute('aria-expanded', 'false');
    }

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const open = menu.style.display === 'block';
      if (open) closeMenu(); else openMenu();
    });

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });

    document.addEventListener('click', (ev) => {
      const clickedInsideBtn = btn.contains(ev.target);
      const clickedInsideMenu = menu.contains(ev.target);
      if (!clickedInsideBtn && !clickedInsideMenu) closeMenu();
    });

    menu.querySelectorAll('.surface-item').forEach(row => {
      const cb = row.querySelector('input[type="checkbox"]');
      row.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const targetTag = ev.target && ev.target.tagName ? ev.target.tagName.toLowerCase() : '';
        if (targetTag === 'input') {
          // native toggle will occur
        } else {
          cb.checked = !cb.checked;
        }
        updateLabel();
      });
      row.addEventListener('keydown', (ev) => {
        if (ev.key === ' ' || ev.key === 'Enter') {
          ev.preventDefault();
          cb.checked = !cb.checked;
          updateLabel();
        }
      });
      cb.addEventListener('change', updateLabel);
    });

    const include = document.getElementById('includeOpenSpace');
    include.addEventListener('change', () => {
      if (include.checked) { openMenu(); setTimeout(updateLabel,10); }
      else closeMenu();
    });

    window.addEventListener('resize', () => {
      if (menu.style.display === 'block' && menu.parentElement === document.body) {
        const rect = btn.getBoundingClientRect();
        menu.style.left = Math.max(8, rect.left) + 'px';
        menu.style.top = (rect.bottom + 6) + 'px';
        menu.style.width = rect.width + 'px';
      }
    });

    // initial label
    updateLabel();
  })();
  </script>

  <!-- Minimal map + drawing logic -->
  <script>
  // init map
  const map = L.map('map', { center: [12.9716,77.5946], zoom: 13 }); // Bangalore coordinates for demo
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // layer for drawn items
  const drawnItems = new L.FeatureGroup().addTo(map);

  // draw control
  const drawControl = new L.Control.Draw({
    draw: {
      polyline: false,
      polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#2266AA' } },
      rectangle: false,
      circle: false,
      marker: false,
      circlemarker: false
    },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  // store polygons: first drawn polygon = roof; second (if includeOpenSpace) = ground
  let roofLayer = null;
  let groundLayer = null;

  function areaSqMFromLayer(layer) {
    try {
      const geojson = layer.toGeoJSON();
      // turf area returns square meters
      const a = turf.area(geojson);
      return Math.round(a * 100) / 100;
    } catch (e) {
      return 0;
    }
  }

  function updateAreasDisplay() {
    document.getElementById('roofArea').textContent = roofLayer ? areaSqMFromLayer(roofLayer) : 0;
    if (groundLayer) {
      document.getElementById('groundAreaWrap').classList.remove('hidden');
      document.getElementById('groundArea').textContent = areaSqMFromLayer(groundLayer);
    } else {
      document.getElementById('groundAreaWrap').classList.add('hidden');
    }
  }

  map.on(L.Draw.Event.CREATED, function (event) {
    const layer = event.layer;
    // simple logic: first polygon = roof, second = ground (if includeOpenSpace)
    if (!roofLayer) {
      roofLayer = layer;
      layer.setStyle({ color: '#1e90ff', fillOpacity: 0.3 });
      drawnItems.addLayer(layer);
    } else if (!groundLayer && document.getElementById('includeOpenSpace').checked) {
      groundLayer = layer;
      layer.setStyle({ color: '#ff9900', fillOpacity: 0.25 });
      drawnItems.addLayer(layer);
    } else {
      // if both exist, replace last one (this is simple; adjust per your app logic)
      drawnItems.addLayer(layer);
    }
    updateAreasDisplay();
  });

  // handle deletions/edits
  map.on(L.Draw.Event.EDITED, function(e) {
    updateAreasDisplay();
  });
  map.on(L.Draw.Event.DELETED, function(e) {
    // if roof or ground removed, clear references if they were removed
    const layers = e.layers;
    layers.eachLayer(layer => {
      if (roofLayer && layer._leaflet_id === roofLayer._leaflet_id) roofLayer = null;
      if (groundLayer && layer._leaflet_id === groundLayer._leaflet_id) groundLayer = null;
    });
    updateAreasDisplay();
  });

  // analyze button: simple demo output using selected surfaces
  document.getElementById('analyzeBtn').addEventListener('click', () => {
    const roofArea = roofLayer ? areaSqMFromLayer(roofLayer) : 0;
    const groundArea = groundLayer ? areaSqMFromLayer(groundLayer) : 0;
    const surfaces = window.getSelectedGroundSurfaces ? window.getSelectedGroundSurfaces() : [];
    const coefMap = {
      water_tight: 0.82, asphalt: 0.88, open_joints: 0.6, unpaved: 0.2, parks: 0.12
    };
    const coefs = surfaces.map(s => coefMap[s] || 0.3);
    const avgCoef = coefs.length ? (coefs.reduce((a,b)=>a+b,0)/coefs.length) : 0.3;
    const rain = 800; // mm/year - demo static value
    // quick computation: volume = area * rainfall(mm) * runoff coeff (convert mm to m)
    const roofVolume = Math.round((roofArea * (rain/1000) * 0.9) * 100) / 100; // m3/year (roof assumed 0.9 coefficient)
    const groundVolume = Math.round((groundArea * (rain/1000) * avgCoef) * 100) / 100;
    const out = `
      <div style="max-width:600px;">
        <h3 class="text-lg font-semibold">Feasibility snapshot</h3>
        <p>Roof area: <strong>${roofArea} m¬≤</strong> ‚Üí approx. <strong>${roofVolume} m¬≥/year</strong></p>
        <p>Ground area: <strong>${groundArea} m¬≤</strong> ‚Üí approx. <strong>${groundVolume} m¬≥/year</strong></p>
        <p>Selected surfaces: <strong>${surfaces.length ? surfaces.join(', ') : 'None'}</strong></p>
        <p style="font-size:13px; color:#6b7280;">(Rainfall used: ${rain} mm/yr ‚Äî static demo value)</p>
      </div>
    `;
    const res = document.getElementById('analysisResult');
    res.innerHTML = out;
    res.classList.remove('hidden');
  });
  </script>
</body>
</html>
